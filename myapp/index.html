<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모바일 주문 및 정산 관리 (V4 - PIN 인증)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="config.js"></script>

    <style>
        /* 커스텀 스타일 및 모바일 최적화 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* 모바일 최적화를 위해 메인 컨테이너 최대 너비 유지 및 패딩 조정 */
        .main-container {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .task-item {
            cursor: pointer;
            transition: all 0.2s;
        }
        .task-item:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }
        /* 상태별 색상 유지 */
        .task-paid { border-left: 4px solid #10b981; background-color: #ecfdf5; }
        .task-requested { border-left: 4px solid #f59e0b; background-color: #fffdf5; }
        .task-completed { border-left: 4px solid #3b82f6; background-color: #ebf8ff; }
        .task-processing { border-left: 4px solid #a855f7; background-color: #f3e8ff; }
        .task-ready { border-left: 4px solid #94a3b8; background-color: #f8fafc; } /* Gray for Ready */

        /* 로딩 스피너 스타일 */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform-origin: center; transform: rotate(360deg); }
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }

        /* 모달 스타일 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 95%; /* 모바일에서 넓게 */
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        /* 자동완성 목록 스타일 */
        .autocomplete-list {
            position: absolute;
            z-index: 10;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ccc;
            border-top: none;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 8px 8px;
        }
        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .autocomplete-item:hover {
            background-color: #f3f4f6;
        }
        /* 거래처 그룹 스타일 추가 */
        .client-group-container {
            border: 1px solid #e5e7eb; /* Light gray border */
            border-radius: 0.5rem; /* Rounded corners */
            margin-bottom: 1.5rem !important; /* Adjust spacing between groups */
        }
        .client-header {
            border-bottom: 1px solid #e5e7eb; /* Header separator */
        }
        .task-item-group {
            border-top: none;
            border-left: none;
            border-right: none;
            border-bottom: 1px solid #f3f4f6; /* Very light separator for tasks */
        }
        .task-item-group:last-child {
            border-bottom: none;
        }
        .statement-text {
            white-space: pre-wrap; /* 명세서 텍스트 줄바꿈 유지 */
        }
        /* PIN 입력 칸 */
        .pin-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            border: 2px solid #ccc;
            border-radius: 8px;
        }
    </style>
</head>
<body class="p-2 sm:p-4 min-h-screen">

    <div id="pinAuthModal" class="modal-overlay hidden">
        <div class="modal-content text-center max-w-sm">
            <h3 id="pinModalTitle" class="text-2xl font-bold mb-4 text-gray-800">PIN 인증</h3>
            <p id="pinModalMessage" class="text-sm text-gray-600 mb-6">4자리 PIN 코드를 입력하세요.</p>
            
            <div class="flex justify-center space-x-3 mb-6">
                <input type="password" maxlength="1" id="pin1" class="pin-input focus:border-blue-500" inputmode="numeric" pattern="[0-9]*">
                <input type="password" maxlength="1" id="pin2" class="pin-input focus:border-blue-500" inputmode="numeric" pattern="[0-9]*" disabled>
                <input type="password" maxlength="1" id="pin3" class="pin-input focus:border-blue-500" inputmode="numeric" pattern="[0-9]*" disabled>
                <input type="password" maxlength="1" id="pin4" class="pin-input focus:border-blue-500" inputmode="numeric" pattern="[0-9]*" disabled>
            </div>
            
            <p id="pinError" class="text-red-500 text-sm mb-4 hidden"></p>

            <button id="pinSubmitButton" disabled
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-150 ease-in-out shadow-md disabled:opacity-50">
                확인
            </button>
        </div>
    </div>


    <div id="appContainer" class="hidden">
        <div class="main-container bg-white p-4 sm:p-6 rounded-xl shadow-2xl">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4 sm:mb-6 border-b pb-2">모바일 주문/정산 관리 (V4)</h1>

            <div class="flex justify-between items-center mb-4">
                <p id="userIdDisplay" class="text-xs text-gray-500 truncate">사용자 ID: 로딩 중...</p>
                <button id="openProductManagementButton" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-full transition">제품 관리</button>
            </div>
            
            <div class="flex border-b border-gray-200 mb-4 sm:mb-6">
                <button id="tab-progress" class="tab-button active flex-1 py-2 sm:py-3 px-2 sm:px-4 text-center border-b-2 border-transparent text-gray-600 hover:text-blue-600 transition" onclick="switchTab('progress')">진행중</button>
                <button id="tab-completed" class="tab-button flex-1 py-2 sm:py-3 px-2 sm:px-4 text-center border-b-2 border-transparent text-gray-600 hover:text-blue-600 transition" onclick="switchTab('completed')">완료 및 정산</button>
                <button id="tab-stats" class="tab-button flex-1 py-2 sm:py-3 px-2 sm:px-4 text-center border-b-2 border-transparent text-gray-600 hover:text-blue-600 transition" onclick="switchTab('stats')">통계</button>
            </div>

            <div id="loadingIndicator" class="flex justify-center items-center py-8">
                <div class="spinner"></div>
                <p class="ml-3 text-gray-500">데이터 로딩 중...</p>
            </div>

            <div id="tabContent-progress" class="tab-content space-y-4"> 
                <button id="openAddTaskModalButton"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg">
                    + 새 작업 등록 (팝업)
                </button>
                
                <h2 class="text-xl font-semibold text-gray-700 pt-4 border-t">진행중인 작업 목록 (준비, 제판)</h2>
                <div id="progressTaskList" class="space-y-6">
                    </div>
                <div class="mt-4 text-sm text-gray-600" id="progressCount">총 0개의 작업이 진행중입니다.</div>
            </div>

            <div id="tabContent-completed" class="tab-content hidden space-y-4">
                <h2 class="text-xl font-semibold text-gray-700">정산 대기 중인 작업 (완료, 정산 요청됨)</h2>
                
                <div class="p-4 border border-amber-200 rounded-lg bg-amber-50 shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-md font-medium text-gray-700">정산 요청 대상 (상태: 완료):</span>
                        <span id="completedCount" class="text-xl font-bold text-amber-600">0 건</span>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-md font-medium text-gray-700">총 정산 예상 금액 (수입):</span>
                        <span id="settlementTotal" class="text-2xl font-extrabold text-blue-600">0원</span>
                    </div>
                    <button id="openSettlementPreviewButton"
                            class="w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 rounded-lg transition duration-150 ease-in-out shadow-lg disabled:opacity-50"
                            disabled>
                        총 정산 요청 명세서 미리보기
                    </button>
                </div>
                
                <h2 class="text-xl font-semibold text-gray-700 pt-4 border-t">정산 대기 및 요청된 작업 목록</h2>
                <div id="completedTaskList" class="space-y-6">
                    <p class="text-center text-gray-500 p-4" id="noCompletedTasks">완료된 작업이 없습니다.</p>
                </div>
            </div>

            <div id="tabContent-stats" class="tab-content hidden space-y-4">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">기간별 매출 및 순이익 통계</h2>
                
                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50 flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
                    <div class="flex-1">
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">시작일:</label>
                        <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">종료일:</label>
                        <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <button id="calculateStatsButton"
                            class="md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg self-end transition duration-150 ease-in-out">
                        통계 계산
                    </button>
                </div>
                
                <div id="statsSummary" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center pt-4">
                    <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                        <p class="text-sm text-blue-800 font-medium">총 수입</p>
                        <p id="totalRevenue" class="text-2xl font-bold text-blue-600 mt-1">0원</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg shadow-md">
                        <p class="text-sm text-red-800 font-medium">총 지출</p>
                        <p id="totalExpense" class="text-2xl font-bold text-red-600 mt-1">0원</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg shadow-md">
                        <p class="text-sm text-green-800 font-medium">순이익</p>
                        <p id="netIncome" class="text-2xl font-bold text-green-600 mt-1">0원</p>
                    </div>
                </div>

                <h2 class="text-xl font-semibold text-gray-700 pt-4 border-t">지급 완료된 작업</h2>
                <div id="paidTaskList" class="space-y-6">
                    <p class="text-center text-gray-500 p-4" id="noPaidTasks">지급 완료된 작업이 없습니다.</p>
                </div>
            </div>
            
        </div>
    </div>

    <div id="addTaskModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4">새 작업 등록</h3>
            <p class="text-sm text-gray-500 mb-4">연속 등록을 위해 '취소' 버튼을 눌러야 팝업이 닫힙니다.</p>
            <div class="space-y-4">
                <div class="relative">
                    <label for="clientInput" class="block text-sm font-medium text-gray-700">거래처</label>
                    <input type="text" id="clientInput" placeholder="거래처명을 입력하거나 선택하세요"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1" autocomplete="off">
                    <div id="clientAutocompleteList" class="autocomplete-list hidden"></div>
                </div>

                <div class="relative">
                    <label for="productInput" class="block text-sm font-medium text-gray-700">제품명</label>
                    <input type="text" id="productInput" placeholder="제품명을 입력하거나 선택하세요"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1" autocomplete="off">
                    <div id="productAutocompleteList" class="autocomplete-list hidden"></div>
                </div>

                <div>
                    <label for="quantityInput" class="block text-sm font-medium text-gray-700">수량</label>
                    <input type="number" id="quantityInput" value="1" min="1"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1">
                </div>

                <div>
                    <label for="unitPriceInput" class="block text-sm font-medium text-gray-700">단가</label>
                    <input type="number" id="unitPriceInput" value="10000" min="0"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1">
                </div>

                <div>
                    <label for="expenseInput" class="block text-sm font-medium text-gray-700">지출/비용</label>
                    <input type="number" id="expenseInput" value="0" min="0"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 mt-1">
                </div>

                <div>
                    <label for="taskDescriptionInput" class="block text-sm font-medium text-gray-700">비고/작업 내용</label>
                    <input type="text" id="taskDescriptionInput" placeholder="추가 설명 (선택 사항)"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1">
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button id="closeModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    취소 (닫기)
                </button>
                <button id="saveTaskButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    작업 등록
                </button>
            </div>
        </div>
    </div>

    <div id="editTaskModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4">작업 편집</h3>
            <input type="hidden" id="editTaskId">
            <div class="space-y-4">
                <div class="relative">
                    <label for="editClientInput" class="block text-sm font-medium text-gray-700">거래처</label>
                    <input type="text" id="editClientInput"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1" autocomplete="off">
                </div>

                <div class="relative">
                    <label for="editProductInput" class="block text-sm font-medium text-gray-700">제품명</label>
                    <input type="text" id="editProductInput"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1" autocomplete="off">
                </div>

                <div>
                    <label for="editQuantityInput" class="block text-sm font-medium text-gray-700">수량</label>
                    <input type="number" id="editQuantityInput" min="1"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1">
                </div>

                <div>
                    <label for="editUnitPriceInput" class="block text-sm font-medium text-gray-700">단가</label>
                    <input type="number" id="editUnitPriceInput" min="0"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1">
                </div>

                <div>
                    <label for="editExpenseInput" class="block text-sm font-medium text-gray-700">지출/비용</label>
                    <input type="number" id="editExpenseInput" min="0"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 mt-1">
                </div>

                <div>
                    <label for="editTaskDescriptionInput" class="block text-sm font-medium text-gray-700">비고/작업 내용</label>
                    <input type="text" id="editTaskDescriptionInput"
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mt-1">
                </div>
            </div>

            <div class="flex justify-between mt-6">
                <button id="deleteTaskInEditModalButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition">
                    삭제
                </button>
                <div class="flex space-x-3">
                    <button id="closeEditModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                        취소
                    </button>
                    <button id="saveEditedTaskButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                        수정 저장
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="productManagementModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4">제품 및 단가 관리</h3>
            
            <div class="space-y-4 p-3 border rounded-lg bg-gray-50 mb-6">
                <p class="font-semibold text-gray-700">새 제품 등록/단가 수정</p>
                <input type="text" id="newProductNameInput" placeholder="제품명"
                       class="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <input type="number" id="newProductPriceInput" placeholder="기본 단가" value="10000" min="0"
                       class="w-full p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="addNewProductButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition">
                    제품 추가/단가 저장
                </button>
            </div>

            <h4 class="text-lg font-semibold mb-3 border-t pt-3">등록된 제품 목록</h4>
            <div id="productListDisplay" class="space-y-2 max-h-60 overflow-y-auto">
                <p class="text-center text-gray-500" id="noProductsFound">등록된 제품이 없습니다.</p>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button id="closeProductManagementButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    닫기
                </button>
            </div>
        </div>
    </div>

    <div id="settlementPreviewModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4">정산 명세서 미리보기</h3>
            <div class="p-4 bg-gray-50 border rounded-lg mb-4 h-64 overflow-y-auto">
                <pre id="settlementStatementText" class="statement-text text-sm text-gray-700 font-mono"></pre>
            </div>

            <p id="copyMessage" class="text-sm text-green-600 hidden mb-2">클립보드에 복사되었습니다!</p>

            <div class="flex justify-between space-x-3 mt-6">
                <button id="copyStatementButton" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    명세서 복사
                </button>
                <button id="confirmSettlementButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                    정산 요청 확정
                </button>
                <button id="closeSettlementPreviewButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
                    취소
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            doc, 
            query, 
            where, 
            getDocs, 
            writeBatch,
            setLogLevel,
            serverTimestamp,
            getDoc, // getDoc 추가
            setDoc // setDoc 추가
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setPersistence 및 browserLocalPersistence 추가
        import { setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ----------------------------------------------------------------------
        // 0. 초기 설정 및 전역 변수
        // ----------------------------------------------------------------------
        setLogLevel('debug'); 

        // DOM 요소 (PIN 인증)
        const pinAuthModal = document.getElementById('pinAuthModal');
        const pinModalTitle = document.getElementById('pinModalTitle');
        const pinModalMessage = document.getElementById('pinModalMessage');
        const pinInputs = [
            document.getElementById('pin1'),
            document.getElementById('pin2'),
            document.getElementById('pin3'),
            document.getElementById('pin4')
        ];
        const pinSubmitButton = document.getElementById('pinSubmitButton');
        const pinError = document.getElementById('pinError');
        const appContainer = document.getElementById('appContainer');

        // DOM 요소 (메인) - 나머지 기존 요소는 그대로 유지
        const tabContents = {
            progress: document.getElementById('tabContent-progress'),
            completed: document.getElementById('tabContent-completed'),
            stats: document.getElementById('tabContent-stats'),
        };
        const taskModal = document.getElementById('addTaskModal');
        const editTaskModal = document.getElementById('editTaskModal');
        const productManagementModal = document.getElementById('productManagementModal');
        const settlementPreviewModal = document.getElementById('settlementPreviewModal'); // 신규 모달
        const openAddTaskModalButton = document.getElementById('openAddTaskModalButton');
        const openProductManagementButton = document.getElementById('openProductManagementButton');
        const openSettlementPreviewButton = document.getElementById('openSettlementPreviewButton'); // 신규 버튼
        const closeProductManagementButton = document.getElementById('closeProductManagementButton');
        const closeSettlementPreviewButton = document.getElementById('closeSettlementPreviewButton'); // 신규 버튼
        const confirmSettlementButton = document.getElementById('confirmSettlementButton'); // 신규 버튼
        const copyStatementButton = document.getElementById('copyStatementButton'); // 신규 버튼
        const copyMessage = document.getElementById('copyMessage'); // 신규 메시지

        const closeModalButton = document.getElementById('closeModalButton');
        const closeEditModalButton = document.getElementById('closeEditModalButton');
        const saveTaskButton = document.getElementById('saveTaskButton');
        const saveEditedTaskButton = document.getElementById('saveEditedTaskButton');
        const deleteTaskInEditModalButton = document.getElementById('deleteTaskInEditModalButton');
        const addNewProductButton = document.getElementById('addNewProductButton');

        // 등록/편집 모달 입력 필드 (기존 변수 재사용)
        const clientInput = document.getElementById('clientInput');
        const clientAutocompleteList = document.getElementById('clientAutocompleteList');
        const productInput = document.getElementById('productInput');
        const productAutocompleteList = document.getElementById('productAutocompleteList');
        const quantityInput = document.getElementById('quantityInput');
        const unitPriceInput = document.getElementById('unitPriceInput');
        const expenseInput = document.getElementById('expenseInput');
        const taskDescriptionInput = document.getElementById('taskDescriptionInput');
        const editTaskId = document.getElementById('editTaskId');
        const editClientInput = document.getElementById('editClientInput');
        const editProductInput = document.getElementById('editProductInput');
        const editQuantityInput = document.getElementById('editQuantityInput');
        const editUnitPriceInput = document.getElementById('editUnitPriceInput');
        const editExpenseInput = document.getElementById('editExpenseInput');
        const editTaskDescriptionInput = document.getElementById('editTaskDescriptionInput');
        
        // 제품 관리 모달 필드
        const newProductNameInput = document.getElementById('newProductNameInput');
        const newProductPriceInput = document.getElementById('newProductPriceInput');
        const productListDisplay = document.getElementById('productListDisplay');
        const noProductsFound = document.getElementById('noProductsFound');

        // 정산 명세서 필드
        const settlementStatementText = document.getElementById('settlementStatementText');


        // 기타 UI 요소
        const progressTaskList = document.getElementById('progressTaskList');
        const completedTaskList = document.getElementById('completedTaskList');
        const paidTaskList = document.getElementById('paidTaskList');
        const progressCountSpan = document.getElementById('progressCount');
        const completedCountSpan = document.getElementById('completedCount');
        const settlementTotalSpan = document.getElementById('settlementTotal');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noCompletedTasks = document.getElementById('noCompletedTasks');
        const noPaidTasks = document.getElementById('noPaidTasks');

        // 환경 변수 로드
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        let isPinSet = false; // PIN 설정 여부
        let tasks = []; 
        let clients = []; 
        let products = []; 

        // 상태 코드 매핑 (사용자에게 표시될 텍송)
        const STATUS_MAP = {
            'ready': '준비',
            'processing': '제판',
            'completed': '완료',
            'settlement_requested': '요청됨', 
            'paid': '지급 완료'
        };
        const DROPDOWN_STATUS_OPTIONS = ['ready', 'processing', 'completed', 'paid'];


        // ----------------------------------------------------------------------
        // 1. Firebase 초기화 및 인증
        // ----------------------------------------------------------------------
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // **[수정] 영속성(Persistence) 설정:**
            setPersistence(auth, browserLocalPersistence)
                .then(async () => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userIdDisplay.textContent = `사용자 ID: ${userId}`;
                            
                            // 핀 인증 상태 확인 후 앱 로드
                            await checkPinStatusAndLoadApp();

                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("Firebase 인증 오류:", error);
                                loadingIndicator.classList.add('hidden');
                                userIdDisplay.textContent = `사용자 ID: 인증 실패`;
                            }
                        }
                    });
                });

        } catch (error) {
            console.error("Firebase 초기화 오류:", error);
            loadingIndicator.classList.add('hidden');
        }

        // ----------------------------------------------------------------------
        // 1.5 PIN 인증 로직 (새로 추가됨)
        // ----------------------------------------------------------------------

        function getProfileDocRef() {
            return doc(db, `artifacts/${appId}/users/${userId}/profile`, 'settings');
        }

        async function checkPinStatusAndLoadApp() {
            loadingIndicator.classList.remove('hidden');

            const docRef = getProfileDocRef();
            const docSnap = await getDoc(docRef);

            isPinSet = docSnap.exists() && docSnap.data().pinHash;

            loadingIndicator.classList.add('hidden');

            if (isPinSet) {
                // PIN이 설정되어 있음: PIN 입력 모달 표시
                openPinAuthModal('check');
            } else {
                // PIN이 설정되어 있지 않음: PIN 설정 모달 표시
                openPinAuthModal('set');
            }
        }
        
        function openPinAuthModal(mode, retryPin = null) {
            pinAuthModal.classList.remove('hidden');
            pinInputs.forEach(input => input.value = '');
            pinInputs[0].focus();
            pinSubmitButton.disabled = true;
            pinError.classList.add('hidden');

            if (mode === 'set') {
                pinModalTitle.textContent = '새 PIN 설정 (4자리)';
                pinModalMessage.textContent = '앱 보안을 위해 사용할 4자리 PIN을 설정해주세요.';
                pinSubmitButton.onclick = () => setPin(null);
            } else if (mode === 'check') {
                pinModalTitle.textContent = 'PIN 입력';
                pinModalMessage.textContent = '설정된 4자리 PIN을 입력하세요.';
                pinSubmitButton.onclick = () => checkPin();
            } else if (mode === 'confirm') {
                pinModalTitle.textContent = 'PIN 재확인';
                pinModalMessage.textContent = 'PIN을 다시 한번 입력해주세요.';
                pinSubmitButton.onclick = () => setPin(retryPin);
            }
        }
        
        function getPinValue() {
            return pinInputs.map(input => input.value).join('');
        }

        // PIN 입력창 이동 및 확인 로직
        pinInputs.forEach((input, index) => {
            input.addEventListener('input', () => {
                // 숫자 외 입력 방지
                input.value = input.value.replace(/\D/g, ''); 
                
                // 다음 칸으로 자동 이동
                if (input.value.length === 1 && index < pinInputs.length - 1) {
                    pinInputs[index + 1].disabled = false;
                    pinInputs[index + 1].focus();
                }

                // PIN이 모두 입력되었는지 확인
                const isComplete = pinInputs.every(i => i.value.length === 1);
                pinSubmitButton.disabled = !isComplete;
            });
            input.addEventListener('keydown', (e) => {
                // Backspace 처리
                if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                    pinInputs[index - 1].value = '';
                    pinInputs[index - 1].focus();
                    pinInputs[index].disabled = true;
                }
            });
        });


        // PIN 설정 (Hashing은 보안상 권장되나, 이 환경에서는 단순 문자열로 저장)
        async function setPin(firstPin) {
            const currentPin = getPinValue();
            
            if (currentPin.length !== 4) {
                pinError.textContent = '4자리 PIN을 모두 입력해주세요.';
                pinError.classList.remove('hidden');
                return;
            }

            if (firstPin === null) {
                // PIN 첫 설정 -> 확인 단계로 이동
                openPinAuthModal('confirm', currentPin);
                return;
            }

            if (firstPin !== currentPin) {
                // PIN 재확인 실패
                pinError.textContent = 'PIN이 일치하지 않습니다. 다시 시도해주세요.';
                pinError.classList.remove('hidden');
                openPinAuthModal('set', null); // 처음부터 다시 설정
                return;
            }

            // PIN Firestore에 저장 (실제 환경에서는 SHA-256 등으로 해싱하여 저장해야 합니다!)
            try {
                await setDoc(getProfileDocRef(), { pinHash: currentPin, pinSetAt: serverTimestamp() }, { merge: true });
                isPinSet = true;
                pinAuthModal.classList.add('hidden');
                isAuthReady = true;
                startDataListeners(); // 데이터 로드 시작
                appContainer.classList.remove('hidden');
            } catch (e) {
                pinError.textContent = 'PIN 저장 중 오류가 발생했습니다.';
                pinError.classList.remove('hidden');
                console.error("PIN 저장 오류:", e);
            }
        }
        
        // PIN 확인
        async function checkPin() {
            const currentPin = getPinValue();
            if (currentPin.length !== 4) return;
            
            const docSnap = await getDoc(getProfileDocRef());
            const storedPin = docSnap.data()?.pinHash;

            if (currentPin === storedPin) {
                // PIN 인증 성공!
                pinAuthModal.classList.add('hidden');
                isAuthReady = true;
                startDataListeners(); // 데이터 로드 시작
                appContainer.classList.remove('hidden');
            } else {
                // PIN 인증 실패
                pinError.textContent = 'PIN이 일치하지 않습니다. 다시 시도해주세요.';
                pinError.classList.remove('hidden');
                pinInputs.forEach(input => input.value = '');
                pinInputs[0].focus();
            }
        }
        
        // ----------------------------------------------------------------------
        // 2. Firestore 데이터 리스너 (실시간 동기화)
        // ----------------------------------------------------------------------

        function getCollectionPath(collectionName) {
            // 개인 데이터 경로: /artifacts/{appId}/users/{userId}/{collectionName}
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        }

        function startDataListeners() {
            if (!db || !userId || !isAuthReady) { // isAuthReady 확인 추가
                console.error("DB, User ID, 또는 PIN 인증이 준비되지 않았습니다.");
                return;
            }

            // Task 리스너
            onSnapshot(query(collection(db, getCollectionPath('tasks'))), (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
                loadingIndicator.classList.add('hidden');
            }, (error) => console.error("Task 리스너 오류:", error));

            // Clients 리스너
            onSnapshot(query(collection(db, getCollectionPath('clients'))), (snapshot) => {
                clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }, (error) => console.error("Client 리스너 오류:", error));

            // Products 리스너 (제품 관리 모달 업데이트 포함)
            onSnapshot(query(collection(db, getCollectionPath('products'))), (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProductManagementList(); // 제품 관리 목록 업데이트
            }, (error) => console.error("Product 리스너 오류:", error));
        }


        // ----------------------------------------------------------------------
        // 3. UI 렌더링 및 상태 업데이트 (거래처 그룹화 적용)
        // ----------------------------------------------------------------------

        function formatCurrency(amount) {
            // 원화 포맷팅
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount);
        }
        
        // 거래처별 그룹화 함수
        function groupTasksByClient(taskList) {
            const grouped = taskList.reduce((acc, task) => {
                const clientName = task.client || '거래처 없음';
                if (!acc[clientName]) {
                    acc[clientName] = [];
                }
                acc[clientName].push(task);
                return acc;
            }, {});
            return grouped;
        }

        function updateUI() {
            // 탭별 데이터 필터링
            let progressTasks = tasks.filter(t => t.status === 'ready' || t.status === 'processing');
            let completedTasks = tasks.filter(t => t.status === 'completed' || t.status === 'settlement_requested');
            let paidTasks = tasks.filter(t => t.status === 'paid');

            // 1. 진행중 탭 렌더링
            renderGroupedTaskList(progressTaskList, progressTasks, 'progress');
            progressCountSpan.textContent = `총 ${progressTasks.length}개의 작업이 진행중입니다.`;

            // 2. 완료 탭 렌더링
            renderGroupedTaskList(completedTaskList, completedTasks, 'completed');
            
            const tasksReadyForSettlement = completedTasks.filter(t => t.status === 'completed');
            const settlementTotal = tasksReadyForSettlement.reduce((sum, t) => sum + (t.revenue || 0), 0);
            
            completedCountSpan.textContent = `${tasksReadyForSettlement.length} 건`;
            settlementTotalSpan.textContent = formatCurrency(settlementTotal);
            openSettlementPreviewButton.disabled = tasksReadyForSettlement.length === 0; // 버튼 활성화/비활성화
            noCompletedTasks.classList.toggle('hidden', completedTasks.length > 0);

            // 3. 통계 탭 렌더링
            renderGroupedTaskList(paidTaskList, paidTasks, 'stats');
            noPaidTasks.classList.toggle('hidden', paidTasks.length > 0);
        }

        function renderGroupedTaskList(container, filteredTasks, tabType) {
            container.innerHTML = '';
            
            if (filteredTasks.length === 0) {
                // 목록이 비어있으면 메시지를 표시하고 종료
                const message = (tabType === 'progress' ? '진행중인 작업이' : tabType === 'completed' ? '정산 대기 중인 작업이' : '지급 완료된 작업이') + ' 없습니다.';
                container.innerHTML = `<p class="text-center text-gray-500 p-4">${message}</p>`;
                return;
            }

            const groupedTasks = groupTasksByClient(filteredTasks);
            const clientNames = Object.keys(groupedTasks).sort(); // 거래처 이름순 정렬

            clientNames.forEach(clientName => {
                // 거래처 그룹 컨테이너 (테두리 적용)
                const clientGroupContainer = document.createElement('div');
                clientGroupContainer.className = 'client-group-container space-y-0';
                
                // 거래처 헤더
                const clientHeader = document.createElement('div');
                clientHeader.className = 'client-header bg-gray-100 p-3 font-bold text-gray-800 text-lg sticky top-0 shadow-sm';
                clientHeader.textContent = clientName;
                clientGroupContainer.appendChild(clientHeader);
                
                const clientGroup = groupedTasks[clientName];

                // 해당 거래처의 작업 목록
                clientGroup.forEach((task, index) => {
                    const taskItem = document.createElement('div');
                    let statusClass = '';
                    
                    if (task.status === 'completed') statusClass = 'task-completed';
                    else if (task.status === 'settlement_requested') statusClass = 'task-requested';
                    else if (task.status === 'paid') statusClass = 'task-paid';
                    else if (task.status === 'processing') statusClass = 'task-processing';
                    else statusClass = 'task-ready';

                    // 항목 클릭 시 편집 모달 열기
                    taskItem.className = `task-item task-item-group flex items-center justify-between p-3 transition ${statusClass}`;
                    taskItem.setAttribute('data-id', task.id);
                    taskItem.onclick = () => openEditModal(task.id);

                    // 작업 내용, 수입/지출 정보
                    const displayLine = document.createElement('p');
                    displayLine.className = 'flex items-center justify-between w-full space-x-4';
                    
                    const mainInfo = document.createElement('span');
                    mainInfo.className = 'flex items-baseline flex-grow truncate';
                    
                    // 제품명 (가장 크게 강조)
                    const productNameSpan = document.createElement('span');
                    productNameSpan.className = 'font-bold text-lg text-gray-800 mr-2 truncate';
                    productNameSpan.textContent = task.productName;

                    // 수량 (두 번째로 크게 강조)
                    const quantitySpan = document.createElement('span');
                    quantitySpan.className = 'font-semibold text-base text-blue-700 flex-shrink-0 whitespace-nowrap';
                    quantitySpan.textContent = `${task.quantity || 0}개`;
                    
                    mainInfo.appendChild(productNameSpan);
                    mainInfo.appendChild(quantitySpan);
                    
                    // 상태 드롭다운
                    const statusDropdown = document.createElement('select');
                    statusDropdown.className = 'text-xs font-semibold px-2 py-1 rounded-lg bg-white border border-gray-300 shadow-sm transition duration-150 ease-in-out cursor-pointer flex-shrink-0';
                    statusDropdown.style.minWidth = '100px';

                    // 드롭다운에 표시할 상태만 필터링합니다. (settlement_requested 제외)
                    const statusOptions = task.status === 'settlement_requested' 
                        ? DROPDOWN_STATUS_OPTIONS.concat(['settlement_requested'])
                        : DROPDOWN_STATUS_OPTIONS;

                    statusOptions.forEach(statusKey => {
                        const option = document.createElement('option');
                        option.value = statusKey;
                        option.textContent = STATUS_MAP[statusKey];
                        if (statusKey === task.status) {
                            option.selected = true;
                        }
                        statusDropdown.appendChild(option);
                    });
                    
                    // 드롭다운 변경 시 상태 업데이트
                    statusDropdown.onchange = (e) => {
                        e.stopPropagation(); 
                        updateTaskStatus(task.id, e.target.value);
                    };
                    statusDropdown.onclick = (e) => e.stopPropagation(); 
                    
                    // 우측 금액 정보 (작게 표시) - 드롭다운 옆에 위치
                    const sideInfo = document.createElement('span');
                    sideInfo.className = 'text-xs text-gray-600 flex-shrink-0 ml-4 whitespace-nowrap text-right hidden sm:inline-block'; // 모바일에서 숨김
                    const revenue = (task.quantity || 0) * (task.unitPrice || 0);
                    sideInfo.innerHTML = `
                        단가: ${formatCurrency(task.unitPrice)} | 
                        합계: <span class="font-semibold text-green-600">${formatCurrency(revenue)}</span>
                    `;

                    displayLine.appendChild(mainInfo);
                    displayLine.appendChild(sideInfo);
                    
                    const actions = document.createElement('div');
                    actions.className = 'flex space-x-2 flex-shrink-0 pt-0 items-center';
                    
                    // 상태 드롭다운 삽입
                    actions.appendChild(statusDropdown);
                    
                    taskItem.appendChild(displayLine);
                    taskItem.appendChild(actions);

                    clientGroupContainer.appendChild(taskItem);
                });
                
                container.appendChild(clientGroupContainer);
            });
        }
        
        function createActionButton(text, classes, onClick) {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = `text-xs font-semibold py-1 px-3 rounded-full transition duration-150 ease-in-out ${classes}`;
            button.onclick = onClick;
            return button;
        }

        // ----------------------------------------------------------------------
        // 4. 모달 및 자동 완성 기능
        // ----------------------------------------------------------------------

        function openModal() {
            taskModal.classList.remove('hidden');
            // '새 작업 등록' 시 거래처명은 유지, 제품 관련 필드만 초기화
            // clientInput.value = ''; // 연속 입력을 위해 주석 처리
            productInput.value = '';
            quantityInput.value = '1';
            unitPriceInput.value = '10000';
            expenseInput.value = '0';
            taskDescriptionInput.value = '';
            productInput.focus(); // 제품 입력으로 포커스 이동
        }

        function closeModal() {
            taskModal.classList.add('hidden');
            clientAutocompleteList.classList.add('hidden');
            productAutocompleteList.classList.add('hidden');
        }
        
        function openEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editTaskId.value = taskId;
            editClientInput.value = task.client || '';
            editProductInput.value = task.productName || '';
            editQuantityInput.value = task.quantity || 1;
            editUnitPriceInput.value = task.unitPrice || 0;
            editExpenseInput.value = task.expense || 0;
            editTaskDescriptionInput.value = task.description || '';

            editTaskModal.classList.remove('hidden');
        }

        function closeEditModal() {
            editTaskModal.classList.add('hidden');
        }

        function openProductManagementModal() {
            productManagementModal.classList.remove('hidden');
        }

        function closeProductManagementModal() {
            productManagementModal.classList.add('hidden');
        }

        // --- 정산 명세서 생성 및 미리보기 (요청 형식으로 수정됨) ---
        function generateSettlementStatement() {
            const tasksToSettle = tasks.filter(t => t.status === 'completed');
            if (tasksToSettle.length === 0) return "정산 요청할 완료된 작업이 없습니다.";

            const grouped = groupTasksByClient(tasksToSettle);
            let overallTotal = 0;
            
            // 날짜 포맷 (예: 2025. 12. 4. 형태)
            const date = new Date().toLocaleDateString('ko-KR'); 
            
            let statement = `정산 요청 명세서 (${date})\n\n`;

            for (const clientName in grouped) {
                const clientTasks = grouped[clientName];
                
                // 1. 거래처 이름
                statement += `${clientName}\n`; 

                clientTasks.forEach(task => {
                    const revenue = (task.quantity || 0) * (task.unitPrice || 0);
                    overallTotal += revenue; 
                    
                    // 2. 제품명	수량	단가	합계 (탭을 사용하여 간결하게)
                    const paddedName = task.productName.padEnd(10, ' ');
                    
                    statement += `${paddedName}\t${task.quantity || 0}개\t${formatCurrency(task.unitPrice)}\t${formatCurrency(revenue)}\n`;
                });
            }
            
            // 마지막 줄 바꿈 정리
            statement = statement.trim() + '\n\n';

            // 3. 총 정산 금액
            statement += `정산 요청 금액:\t${formatCurrency(overallTotal)}\n`;
            
            return statement;
        }

        function openSettlementPreviewModal() {
            const statement = generateSettlementStatement();
            settlementStatementText.textContent = statement;
            settlementPreviewModal.classList.remove('hidden');
            copyMessage.classList.add('hidden');
        }
        
        function closeSettlementPreviewModal() {
            settlementPreviewModal.classList.add('hidden');
        }

        // --- 클립보드 복사 함수 ---
        function copyStatementToClipboard() {
            const text = settlementStatementText.textContent;
            try {
                // document.execCommand('copy') 사용 (iFrame 환경 호환성)
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                copyMessage.textContent = '클립보드에 복사되었습니다!';
                copyMessage.classList.remove('hidden');
                setTimeout(() => {
                    copyMessage.classList.add('hidden');
                }, 2000);
            } catch (err) {
                copyMessage.textContent = '복사 실패! (콘솔 확인)';
                copyMessage.classList.remove('hidden');
                console.error('클립보드 복사 실패:', err);
            }
        }


        // --- 제품 관리 목록 렌더링 ---
        function renderProductManagementList() {
            productListDisplay.innerHTML = '';
            if (products.length === 0) {
                productListDisplay.appendChild(noProductsFound);
                return;
            }
            noProductsFound.classList.add('hidden');

            products.forEach(product => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center p-2 border-b last:border-b-0 bg-white rounded-md shadow-sm';
                itemDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${product.name}</p>
                        <p class="text-sm text-gray-500">${formatCurrency(product.defaultUnitPrice || 0)}</p>
                    </div>
                    <button data-id="${product.id}" class="delete-product-btn text-xs bg-red-100 text-red-700 hover:bg-red-200 font-medium py-1 px-2 rounded-full transition">삭제</button>
                `;
                productListDisplay.appendChild(itemDiv);
            });
            
            // 삭제 버튼 리스너 재등록
            productListDisplay.querySelectorAll('.delete-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.getAttribute('data-id');
                    console.warn("작업 삭제 요청됨."); 
                    deleteProduct(productId);
                });
            });
        }


        // --- 자동 완성 로직 ---
        function renderAutocomplete(inputElement, listElement, data, key, isProduct = false) {
            listElement.innerHTML = '';
            const value = inputElement.value.toLowerCase();

            if (!value) {
                listElement.classList.add('hidden');
                return;
            }

            const filteredData = data.filter(item => 
                item[key].toLowerCase().includes(value)
            ).slice(0, 5); 

            if (filteredData.length === 0) {
                listElement.classList.add('hidden');
                return;
            }

            filteredData.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'autocomplete-item';
                itemDiv.textContent = item[key] + (isProduct ? ` (${formatCurrency(item.defaultUnitPrice)})` : '');
                itemDiv.onclick = () => {
                    inputElement.value = item[key];
                    listElement.classList.add('hidden');
                    // 제품명 선택 시 단가 자동 입력
                    if (isProduct && item.defaultUnitPrice !== undefined) {
                        unitPriceInput.value = item.defaultUnitPrice;
                    }
                };
                listElement.appendChild(itemDiv);
            });

            listElement.style.top = `${inputElement.offsetHeight}px`;
            listElement.style.left = `0`;
            listElement.classList.remove('hidden');
        }

        // 등록 모달 자동 완성 리스너
        clientInput.addEventListener('input', () => {
            renderAutocomplete(clientInput, clientAutocompleteList, clients, 'name');
        });
        // 제품명 입력 시 단가 자동 완성
        productInput.addEventListener('input', () => {
            renderAutocomplete(productInput, productAutocompleteList, products, 'name', true);
            // 제품명 변경 시 단가 리셋 (수동 입력 유도)
            const matchedProduct = products.find(p => p.name.toLowerCase() === productInput.value.toLowerCase());
            if (!matchedProduct) {
                 unitPriceInput.value = '0';
            }
        });
        
        // ----------------------------------------------------------------------
        // 5. Firestore CRUD 및 상태 관리 함수
        // ----------------------------------------------------------------------

        // 작업 추가 (status: 'ready')
        async function saveTask() {
            const client = clientInput.value.trim();
            const productName = productInput.value.trim();
            const quantity = parseInt(quantityInput.value) || 0;
            const unitPrice = parseInt(unitPriceInput.value) || 0;
            const expense = parseInt(expenseInput.value) || 0;
            const description = taskDescriptionInput.value.trim();
            const revenue = quantity * unitPrice; // 합계 계산

            if (!client || !productName || quantity <= 0 || !isAuthReady) {
                console.error("거래처, 제품명, 수량은 필수 입력 항목입니다.");
                return;
            }
            
            try {
                // 1. Task 저장
                await addDoc(collection(db, getCollectionPath('tasks')), {
                    client: client,
                    productName: productName,
                    quantity: quantity,
                    unitPrice: unitPrice,
                    revenue: revenue,
                    expense: expense,
                    description: description,
                    status: 'ready', // 초기 상태는 '준비'
                    createdAt: serverTimestamp()
                });
                
                // 2. 새로운 거래처/제품이면 마스터 데이터에 저장
                if (!clients.some(c => c.name === client)) {
                    await addDoc(collection(db, getCollectionPath('clients')), { name: client, createdAt: serverTimestamp() });
                }
                if (!products.some(p => p.name === productName)) {
                    await addDoc(collection(db, getCollectionPath('products')), { name: productName, defaultUnitPrice: unitPrice, createdAt: serverTimestamp() });
                } else {
                    const existingProduct = products.find(p => p.name === productName);
                    // 기존 제품의 단가가 변경되었으면 마스터 업데이트
                    if (existingProduct.defaultUnitPrice !== unitPrice) {
                         await updateDoc(doc(db, getCollectionPath('products'), existingProduct.id), { defaultUnitPrice: unitPrice });
                    }
                }

                // 연속 등록을 위해 제품/수량/단가/지출/비고 필드만 초기화 (거래처는 유지)
                productInput.value = '';
                quantityInput.value = '1';
                unitPriceInput.value = '10000';
                expenseInput.value = '0';
                taskDescriptionInput.value = '';
                productInput.focus();
                
            } catch (e) {
                console.error("작업 추가 중 오류 발생: ", e);
            }
        }
        
        // 작업 편집 저장
        async function saveEditedTask() {
            const taskId = editTaskId.value;
            const client = editClientInput.value.trim();
            const productName = editProductInput.value.trim();
            const quantity = parseInt(editQuantityInput.value) || 0;
            const unitPrice = parseInt(editUnitPriceInput.value) || 0;
            const expense = parseInt(editExpenseInput.value) || 0;
            const description = editTaskDescriptionInput.value.trim();
            const revenue = quantity * unitPrice;

            if (!client || !productName || quantity <= 0 || !isAuthReady) {
                console.error("거래처, 제품명, 수량은 필수 입력 항목입니다.");
                return;
            }

            try {
                const taskRef = doc(db, getCollectionPath('tasks'), taskId);
                await updateDoc(taskRef, {
                    client: client,
                    productName: productName,
                    quantity: quantity,
                    unitPrice: unitPrice,
                    revenue: revenue, // 재계산하여 업데이트
                    expense: expense,
                    description: description,
                    updatedAt: serverTimestamp()
                });
                
                // 마스터 데이터 업데이트 로직 재사용 (단가 업데이트)
                if (!clients.some(c => c.name === client)) {
                    await addDoc(collection(db, getCollectionPath('clients')), { name: client, createdAt: serverTimestamp() });
                }
                if (!products.some(p => p.name === productName)) {
                    await addDoc(collection(db, getCollectionPath('products')), { name: productName, defaultUnitPrice: unitPrice, createdAt: serverTimestamp() });
                } else {
                    const existingProduct = products.find(p => p.name === productName);
                    if (existingProduct && existingProduct.defaultUnitPrice !== unitPrice) {
                         await updateDoc(doc(db, getCollectionPath('products'), existingProduct.id), { defaultUnitPrice: unitPrice });
                    }
                }

                closeEditModal();
            } catch (e) {
                console.error("작업 편집 저장 중 오류 발생: ", e);
            }
        }

        // 작업 상태 변경 (드롭다운에서 호출)
        async function updateTaskStatus(taskId, newStatus) {
            if (!isAuthReady) return;
            // NOTE: 정산 요청됨 상태는 드롭다운으로 변경 불가능하게 처리됨.
            if (newStatus === 'settlement_requested') {
                console.warn("정산 요청됨 상태는 정산 요청 미리보기 모달을 통해서만 변경되어야 합니다.");
                return;
            }

            try {
                const taskRef = doc(db, getCollectionPath('tasks'), taskId);
                
                const updateData = { status: newStatus };

                // 상태에 따른 타임스탬프 기록 (이전 상태는 유지)
                if (newStatus === 'completed') {
                    updateData.completionDate = serverTimestamp();
                } else if (newStatus === 'paid') {
                    updateData.paymentDate = serverTimestamp();
                }

                await updateDoc(taskRef, updateData);
            } catch (e) {
                console.error(`작업 상태 (${newStatus}) 업데이트 중 오류 발생: `, e);
            }
        }

        // 정산 요청 (모든 'completed' 작업을 'settlement_requested'로 일괄 변경)
        async function requestSettlement() {
            if (!isAuthReady) return;
            
            const tasksToSettle = tasks.filter(t => t.status === 'completed');
            if (tasksToSettle.length === 0) return;

            try {
                const batch = writeBatch(db);
                const settlementDate = serverTimestamp();

                tasksToSettle.forEach((task) => {
                    const taskRef = doc(db, getCollectionPath('tasks'), task.id);
                    batch.update(taskRef, { 
                        status: 'settlement_requested',
                        settlementDate: settlementDate
                    });
                });

                await batch.commit();
                closeSettlementPreviewModal(); // 요청 확정 후 모달 닫기
            } catch (e) {
                console.error("정산 요청 중 오류 발생: ", e);
            }
        }

        // 작업 삭제
        async function deleteTask(taskId) {
            if (!isAuthReady) return;
            try {
                const taskRef = doc(db, getCollectionPath('tasks'), taskId);
                await deleteDoc(taskRef);
            } catch (e) {
                console.error("작업 삭제 중 오류 발생: ", e);
            }
        }

        // --- 제품 관리 CRUD ---
        async function saveNewProduct() {
            const name = newProductNameInput.value.trim();
            const price = parseInt(newProductPriceInput.value) || 0;

            if (!name || price < 0 || !isAuthReady) {
                console.error("제품명과 0 이상의 단가를 입력하세요.");
                return;
            }

            try {
                if (products.some(p => p.name === name)) {
                    // 이미 존재하는 제품이면 업데이트 (단가 변경)
                    const existingProduct = products.find(p => p.name === name);
                    await updateDoc(doc(db, getCollectionPath('products'), existingProduct.id), { defaultUnitPrice: price, updatedAt: serverTimestamp() });
                } else {
                    // 신규 제품 등록
                    await addDoc(collection(db, getCollectionPath('products')), { name, defaultUnitPrice: price, createdAt: serverTimestamp() });
                }
                
                newProductNameInput.value = '';
                newProductPriceInput.value = '10000';
            } catch (e) {
                console.error("제품 추가 중 오류 발생:", e);
            }
        }

        async function deleteProduct(productId) {
            if (!isAuthReady) return;
            try {
                const productRef = doc(db, getCollectionPath('products'), productId);
                await deleteDoc(productRef);
            } catch (e) {
                console.error("제품 삭제 중 오류 발생:", e);
            }
        }


        // 통계 계산 (status: 'paid' 작업만 필터링)
        document.getElementById('calculateStatsButton').addEventListener('click', () => {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            
            let filteredPaidTasks = tasks.filter(t => t.status === 'paid');

            // JS에서 날짜 필터링 수행
            if (startDateStr) {
                const startDate = new Date(startDateStr);
                filteredPaidTasks = filteredPaidTasks.filter(t => t.paymentDate && t.paymentDate.toDate() >= startDate);
            }
            if (endDateStr) {
                const endDate = new Date(endDateStr);
                endDate.setDate(endDate.getDate() + 1);
                filteredPaidTasks = filteredPaidTasks.filter(t => t.paymentDate && t.paymentDate.toDate() < endDate);
            }

            const totalRevenue = filteredPaidTasks.reduce((sum, t) => sum + (t.revenue || 0), 0);
            const totalExpense = filteredPaidTasks.reduce((sum, t) => sum + (t.expense || 0), 0);
            const netIncome = totalRevenue - totalExpense;

            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('netIncome').textContent = formatCurrency(netIncome);

            // 필터링된 목록을 paidTaskList에 다시 렌더링
            renderGroupedTaskList(paidTaskList, filteredPaidTasks, 'stats');
            noPaidTasks.classList.toggle('hidden', filteredPaidTasks.length > 0);
        });


        // ----------------------------------------------------------------------
        // 6. 이벤트 리스너 등록
        // ----------------------------------------------------------------------

        openAddTaskModalButton.addEventListener('click', openModal);
        closeModalButton.addEventListener('click', closeModal);
        closeEditModalButton.addEventListener('click', closeEditModal);
        openProductManagementButton.addEventListener('click', openProductManagementModal);
        closeProductManagementButton.addEventListener('click', closeProductManagementModal);
        openSettlementPreviewButton.addEventListener('click', openSettlementPreviewModal); // 미리보기 모달 열기
        closeSettlementPreviewButton.addEventListener('click', closeSettlementPreviewModal); // 미리보기 모달 닫기
        copyStatementButton.addEventListener('click', copyStatementToClipboard); // 복사 버튼
        confirmSettlementButton.addEventListener('click', requestSettlement); // 정산 확정 버튼
        
        saveTaskButton.addEventListener('click', saveTask);
        saveEditedTaskButton.addEventListener('click', saveEditedTask);
        addNewProductButton.addEventListener('click', saveNewProduct);
        
        // 편집 모달 내 삭제 버튼 리스너
        deleteTaskInEditModalButton.addEventListener('click', (e) => {
            e.preventDefault();
            const taskId = editTaskId.value;
            console.warn("작업 편집 모달에서 삭제가 요청됨.");
            if (taskId) {
                deleteTask(taskId);
                closeEditModal();
            }
        });
        
        // 엔터 키로 등록 방지 (모달 내에서)
        taskModal.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveTask();
            }
        });
        
        window.switchTab = (tabId) => {
            currentTab = tabId;
            // 모든 탭을 숨기고 현재 탭만 표시합니다.
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tabContent-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            updateUI(); 
        }

        // 앱이 로드될 때 PIN 인증을 먼저 시작하도록 변경
        // window.onload = () => switchTab('progress'); // 기존 코드 주석 처리
    </script>
</body>
</html>